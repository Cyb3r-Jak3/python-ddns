stages:
- lint
- test
- Test_Build
- Deploy_to_PyPi

include:
  - template: Dependency-Scanning.gitlab-ci.yml
  - template: SAST.gitlab-ci.yml
  - template: License-Scanning.gitlab-ci.yml

.lint:
  stage: lint
  before_script:
    - pip install -U pip pylint flake8 requests
  script:
    - pylint ./pddns
    - flake8 ./pddns

python-3.5-lint:
  extends: ".lint"
  image: python:3.5

python-3.6-lint:
  extends: ".lint"
  image: python:3.6

python-3.7-lint:
  extends: ".lint"
  image: python:3.7

python-3.8-lint:
  extends: ".lint"
  image: python:3.8

.build:
 stage: test
 script:
   - pip install -U setuptools twine --quiet
   - python setup.py sdist bdist_wheel
   - python -m twine check dist/*
 except:
   - tags

python-3.5-build:
  extends: ".build"
  image: python:3.5
  artifacts:
    paths:
    - dist/

python-3.6-build:
  extends: ".build"
  image: python:3.6
  artifacts:
    paths:
    - dist/

python-3.7-build:
  extends: ".build"
  image: python:3.7
  artifacts:
    paths:
    - dist/

python-3.8-build:
  extends: ".build"
  image: python:3.8
  artifacts:
    paths:
    - dist/

.test:
  stage: Test_Build
  script:
    - pip install dist/*.whl
    - pip show -f python_ddns
    - command -v pddns
    - pddns -i -d
    - pddns -t -d
  except:
    - tags

python-3.5-test:
  extends: ".test"
  image: python:3.5

python-3.6-test:
  extends: ".test"
  image: python:3.6

python-3.7-test:
  extends: ".test"
  image: python:3.7

python-3.7-test:
  extends: ".test"
  image: python:3.8

#Build:
#  artifacts:
#     paths:
#     - dist/
#  stage: test
#  image: python:3.7
#  variables:
#    TWINE_USERNAME: $STAGING_USERNAME
#    TWINE_PASSWORD: $STAGING_PASSWORD
#  script:
#    - pip install -U setuptools twine --quiet
#    - python setup.py sdist bdist_wheel
#    - python -m twine check dist/*
#  except:
#    - tags

# Test_Build:
#   stage: Test_Build
#   image: python:3.7
#   script:
#     - pip install dist/*.whl
#     - pip show -f pddns
#     - command -v pddns
#     - pddns -i -d
#     - pddns -t -d
#   except:
#     - tags


Deploy_to_PyPi:
  image: python:3.7
  stage: Deploy_to_PyPi
  variables:
    TWINE_USERNAME: $PRODUCTION_USERNAME
    TWINE_PASSWORD: $PRODUCTION_PASSWORD
  script:
    - pip install -U pip setuptools twine --quiet
    - python setup.py sdist bdist_wheel
    - python -m twine check dist/*
    - python -m twine upload --verbose --username $PRODUCTION_USER --password $PRODUCTION_PASSWORD dist/*
  only:
    refs:
      - tags
      - master
    variables:
      - $CI_COMMIT_TAG